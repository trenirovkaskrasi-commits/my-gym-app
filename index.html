<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê–ë–û–ù–ê–ú–ï–ù–¢–ò</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* –ú–ï–¢–†–û –î–ò–ó–ê–ô–ù –°–ò–°–¢–ï–ú–ê */
        :root {
            --accent: #0078D7;
            --bg: #ffffff;
            --text: #000000;
            --tile: #eff2f5;
            --green: #267a26;
            --blue: #005a9e;
            --red: #a80000;
            --purple: #7232ad;
            --dark-red: #8b0000;
            --font-main: 'Segoe UI', 'Open Sans', sans-serif;
        }

        [data-theme="dark"] {
            --bg: #000000;
            --text: #ffffff;
            --tile: #1a1a1a;
        }

        * {
            box-sizing: border-box;
            border-radius: 0 !important;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-main);
            overflow-x: hidden;
        }

        header {
            background: var(--accent);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 15px; flex: 1; }

        header h1 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 800;
            text-transform: uppercase;
        }

        .search-box {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px;
            width: 0;
            transition: width 0.3s;
            overflow: hidden;
        }
        .search-box.active { width: 150px; border: 1px solid white; }

        /* METRO ICONS STYLE */
        .icon-btn { 
            width: 24px; 
            height: 24px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .icon-btn svg { fill: white; width: 100%; height: 100%; }

        .container {
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* –ö–õ–ò–ï–ù–¢–°–ö–ò –ü–õ–û–ß–ö–ò */
        .klient-tile {
            background: var(--tile);
            display: grid;
            grid-template-columns: 80px 1fr 60px;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .klient-photo { width: 70px; height: 70px; object-fit: cover; border: 1px solid #888; }

        .status-badge { font-weight: 900; font-size: 0.7rem; padding: 2px 6px; display: inline-block; text-transform: uppercase; }
        .active-status { background: var(--green); color: white; }
        .inactive-status { background: var(--red); color: white; }

        .rem-count { font-size: 1.5rem; font-weight: 900; text-align: right; color: var(--accent); }

        /* –§–û–†–ú–ò */
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; font-size: 0.75rem; color: #666; }
        
        input, select, textarea {
            width: 100%; padding: 12px; background: var(--tile); border: 2px solid #ccc;
            color: var(--text); font-family: inherit; font-weight: bold; font-size: 0.95rem;
        }

        .btn {
            border: none; padding: 16px; color: white; font-weight: 900;
            text-transform: uppercase; cursor: pointer; display: block; width: 100%;
            text-align: center; margin-bottom: 8px; font-size: 0.9rem;
        }
        .btn-green { background: var(--green); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-purple { background: var(--purple); }
        .btn-dark-red { background: var(--dark-red); }

        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: var(--accent); color: white; display: flex; align-items: center;
            justify-content: center; font-size: 30px; font-weight: bold; z-index: 99;
        }

        /* –ü–†–û–§–ò–õ –°–ü–ï–¶–ò–§–ò–ß–ù–ò */
        .metro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 10px 0; }
        .metro-counter-tile { background: var(--tile); padding: 15px; text-align: center; }
        .counter-label { font-weight: bold; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px; }
        .counter-value { font-size: 2.8rem; font-weight: 900; line-height: 1; }

        .info-block { font-size: 0.85rem; line-height: 1.4; margin-top: 5px; }
        .info-row { border-bottom: 1px solid rgba(0,0,0,0.05); padding: 2px 0; }

        .hronologiya { background: var(--tile); padding: 10px; margin: 10px 0; }
        .istoriya-item { border-bottom: 1px solid #ccc; padding: 6px 0; font-size: 0.85rem; }

        .view { display: none; }
        .active-view { display: block; }
        .hidden { display: none !important; }
        .tab-btn.active { background: var(--accent); color: white; }
    </style>
</head>
<body data-theme="light">

<header>
    <div class="header-left">
        <div class="icon-btn" onclick="toggleSearch()">
            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </div>
        <input type="text" id="search-input" class="search-box" placeholder="–¢—ä—Ä—Å–∏ –∏–º–µ..." oninput="renderList()">
        <h1 id="header-title">–ê–ë–û–ù–ê–ú–ï–ù–¢–ò</h1>
    </div>
    <div class="icon-btn" onclick="pokajiSektsiya('view-settings')">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87a.49.49 0 0 0 .12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
    </div>
</header>

<div class="container">
    
    <div id="view-main" class="view active-view">
        <div id="klient-list-container"></div>
        <div class="fab" onclick="otvoriDobavyane()">+</div>
    </div>

    <div id="view-add" class="view">
        <h2 id="add-view-title">–ù–û–í –ö–õ–ò–ï–ù–¢</h2>
        <div class="form-group">
            <label>–°–Ω–∏–º–∫–∞</label>
            <input type="file" id="inp-photo" accept="image/*" onchange="obrabotiSnimka(this)">
            <img id="img-preview" style="width:100%; height:180px; object-fit:cover; margin-top:10px; display:none">
        </div>
        <div class="form-group">
            <label>–ò–º–µ –∏ –§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="inp-name">
        </div>
        <div class="form-group">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="inp-phone">
        </div>
        <div class="form-group">
            <label>–ò–º–µ–π–ª –∞–¥—Ä–µ—Å</label>
            <input type="email" id="inp-email">
        </div>
        <div id="subscription-fields">
            <div class="form-group">
                <label>–ê–±–æ–Ω–∞–º–µ–Ω—Ç–µ–Ω –ü–∞–∫–µ—Ç</label>
                <select id="sel-paket" onchange="izchisliTsena()"></select>
            </div>
            <div class="form-group">
                <label>–°—Ä–æ–∫ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç</label>
                <select id="sel-srok" onchange="izchisliTsena()">
                    <option value="0">–ë–µ–∑ —Å—Ä–æ–∫</option>
                    <option value="30">30 –¥–Ω–∏</option>
                    <option value="45">45 –¥–Ω–∏</option>
                    <option value="60">60 –¥–Ω–∏</option>
                </select>
            </div>
            <div class="form-group">
                <label>–û—Ç—Å—Ç—ä–ø–∫–∞</label>
                <select id="sel-otstapka" onchange="izchisliTsena()"></select>
            </div>
            <div id="price-display-box" style="background: var(--tile); padding: 15px; margin-bottom: 20px; border-left: 5px solid var(--accent);">
                <div id="final-price" style="font-size: 1.8rem; font-weight: 900; color: var(--accent);">0.00‚Ç¨</div>
                <div id="price-details" style="font-size: 0.8rem; color: #555; font-weight: bold; margin-top:5px;"></div>
            </div>
        </div>
        <button class="btn btn-blue" onclick="zapaziKlient()">–ó–ê–ü–ê–ó–ò</button>
        <button class="btn btn-red" onclick="pokajiSektsiya('view-main')">–û–¢–ö–ê–ó</button>
    </div>

    <div id="view-profile" class="view">
        <div id="profile-header-content"></div>
        
        <div id="counter-tiles-container"></div>

        <div class="tile" style="background:var(--tile); padding:15px;">
            <label>–í–∏–¥ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</label>
            <select id="sel-trenirovka"></select>
            <button id="btn-markiraj" class="btn btn-green" style="margin-top:10px" onclick="markirajTrenirovka()">–ú–ê–†–ö–ò–†–ê–ô –¢–†–ï–ù–ò–†–û–í–ö–ê</button>
        </div>

        <div class="hronologiya">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <label>–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è</label>
                <button id="btn-toggle-hronologiya" onclick="razshiriHronologiya()" style="background:none; border:none; color:var(--accent); font-weight:bold; cursor:pointer">–í–ò–ñ –í–°–ò–ß–ö–ò</button>
            </div>
            <div id="hronologiya-list"></div>
        </div>

        <button class="btn btn-purple" onclick="generirajOtchet()">–û–¢–ß–ï–¢ / –í–∞–π–±—ä—Ä</button>
        <button class="btn btn-dark-red" onclick="iztriiKlientPotvarjdenie()">–ò–ó–¢–†–ò–í–ê–ù–ï –ù–ê –ê–ö–ê–£–ù–¢</button>
        <button class="btn btn-blue" style="margin-top:10px" onclick="pokajiSektsiya('view-main')">–û–ë–†–ê–¢–ù–û –ö–™–ú –°–ü–ò–°–™–ö–ê</button>
    </div>

    <div id="view-settings" class="view">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò</h2>
        <div style="display:flex; margin-bottom:20px; background:#ccc">
            <button class="tab-btn active" onclick="switchTab('st-view', this)" style="flex:1; padding:15px; border:none; font-weight:bold">–í–™–ù–®–ï–ù –í–ò–î</button>
            <button class="tab-btn" onclick="switchTab('st-data', this)" style="flex:1; padding:15px; border:none; font-weight:bold">–¢–†–ï–ù–ò–†–û–í–ö–ò</button>
            <button class="tab-btn" onclick="switchTab('st-sync', this)" style="flex:1; padding:15px; border:none; font-weight:bold">–ë–ï–ö–™–ü</button>
        </div>
        <div id="st-view" class="tab-pane">
            <div class="form-group"><label>–ó–∞–≥–ª–∞–≤–∏–µ</label><input type="text" id="set-header-text"></div>
            <div class="form-group"><label>–¢–µ–º–∞</label><select id="set-theme"><option value="light">–°–≤–µ—Ç–ª–∞</option><option value="dark">–¢—ä–º–Ω–∞</option></select></div>
            <div class="form-group"><label>–®—Ä–∏—Ñ—Ç</label><select id="set-font"><option value="small">–ú–∞–ª—ä–∫</option><option value="medium">–°—Ä–µ–¥–µ–Ω</option><option value="large">–ì–æ–ª—è–º</option></select></div>
            <div class="form-group"><label>–ê–∫—Ü–µ–Ω—Ç</label><input type="color" id="set-accent"></div>
        </div>
        <div id="st-data" class="tab-pane hidden">
            <label>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</label><textarea id="set-trenirovki" rows="4"></textarea>
            <label>–ü–∞–∫–µ—Ç–∏ (JSON)</label><textarea id="set-paketi" rows="4"></textarea>
            <button class="btn btn-blue" onclick="zapaziNastroiki()">–ó–ê–ü–ê–ó–ò –î–ê–ù–ù–ò</button>
        </div>
        <div id="st-sync" class="tab-pane hidden">
            <label>Google Script URL</label><input type="url" id="set-gas-url">
            <button class="btn btn-blue" onclick="sinhroniziraj()">–°–ò–ù–•–†–û–ù–ò–ó–ò–†–ê–ô</button>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
                <button class="btn btn-green" onclick="eksportDanni()">–ï–ö–°–ü–û–†–¢</button>
                <button class="btn btn-purple" onclick="importDanni()">–ò–ú–ü–û–†–¢</button>
            </div>
        </div>
        <button class="btn btn-blue" style="margin-top:20px" onclick="zapaziNastroiki(); pokajiSektsiya('view-main')">–ó–ê–ü–ê–ó–ò –í–°–ò–ß–ö–û</button>
        <button class="btn btn-red" onclick="pokajiSektsiya('view-main')">–û–¢–ö–ê–ó</button>
    </div>
</div>

<script>
let klienti = JSON.parse(localStorage.getItem('gym_klienti')) || [];
let nastroiki = JSON.parse(localStorage.getItem('gym_settings')) || {
    header: "–ê–ë–û–ù–ê–ú–ï–ù–¢–ò",
    theme: "light",
    fontSize: "medium",
    accent: "#0078D7",
    trenirovki: "–§—É–ª–±–æ–¥–∏, –î—ä—Ä–ø–∞—â–∏ –º—É—Å–∫—É–ª–∏, –ë—É—Ç–∞—â–∏ –º—É—Å–∫—É–ª–∏, –ì–æ—Ä–Ω–∞ —á–∞—Å—Ç, –î–æ–ª–Ω–∞ —á–∞—Å—Ç, –ö—Ä—ä–≥–æ–≤–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –ö—Ä–∞–∫–∞, –†—ä—Ü–µ, –ü—É–¥–æ–≤–∫–∞, –ö–∞—Ä–¥–∏–æ",
    paketi: [
        {broi: 8, tsena: 100}, {broi: 10, tsena: 125}, {broi: 12, tsena: 150},
        {broi: 16, tsena: 200}, {broi: 20, tsena: 250}
    ],
    otstapki: [0, 4, 8],
    gasUrl: ""
};

let tekushtKlientId = null;
let rezhimRedaktirane = false; 
let snimkaBase64 = "";
let hronologiyaRazgurnata = false;

function playBeep() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime); 
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.1); 
    } catch(e) {}
}

function init() {
    prilojiNastroiki();
    renderList();
    popalniSelecti();
}

function prilojiNastroiki() {
    document.getElementById('header-title').innerText = nastroiki.header;
    document.body.setAttribute('data-theme', nastroiki.theme);
    document.documentElement.style.setProperty('--accent', nastroiki.accent);
    document.getElementById('set-header-text').value = nastroiki.header;
    document.getElementById('set-theme').value = nastroiki.theme;
    document.getElementById('set-font').value = nastroiki.fontSize;
    document.getElementById('set-accent').value = nastroiki.accent;
    document.getElementById('set-trenirovki').value = nastroiki.trenirovki;
    document.getElementById('set-paketi').value = JSON.stringify(nastroiki.paketi);
    document.getElementById('set-gas-url').value = nastroiki.gasUrl || "";
}

function popalniSelecti() {
    document.getElementById('sel-paket').innerHTML = nastroiki.paketi.map(p => `<option value="${p.broi}">${p.broi} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ - ${p.tsena}‚Ç¨</option>`).join('');
    document.getElementById('sel-otstapka').innerHTML = nastroiki.otstapki.map(o => `<option value="${o}">${o}%</option>`).join('');
    document.getElementById('sel-trenirovka').innerHTML = nastroiki.trenirovki.split(',').map(t => `<option value="${t.trim()}">${t.trim()}</option>`).join('');
}

function toggleSearch() {
    const inp = document.getElementById('search-input');
    inp.classList.toggle('active');
    if (inp.classList.contains('active')) inp.focus();
}

function renderList() {
    const query = document.getElementById('search-input').value.toLowerCase();
    const container = document.getElementById('klient-list-container');
    container.innerHTML = "";
    const filtred = klienti.filter(k => k.name.toLowerCase().includes(query));
    filtred.forEach(k => {
        const ostavashti = k.abonament ? (k.abonament.broi - k.abonament.napraveni) : 0;
        const statusClass = ostavashti > 0 ? "active-status" : "inactive-status";
        const statusText = ostavashti > 0 ? "–ê–ö–¢–ò–í–ï–ù" : "–ù–ï–ê–ö–¢–ò–í–ï–ù";
        const tile = document.createElement('div');
        tile.className = "klient-tile";
        tile.onclick = () => otvoriProfil(k.id);
        tile.innerHTML = `
            <img src="${k.photo || 'https://via.placeholder.com/80'}" class="klient-photo">
            <div style="padding-left:10px">
                <div style="font-weight:900; text-transform:uppercase; font-size:0.9rem">${k.name}</div>
                <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <div class="rem-count">${ostavashti}</div>
        `;
        container.appendChild(tile);
    });
}

function izchisliKrainaData(dni) {
    if (dni == 0) return "–ë–µ–∑—Å—Ä–æ—á–µ–Ω";
    let d = new Date();
    d.setDate(d.getDate() + parseInt(dni));
    return d.toLocaleDateString('bg-BG');
}

function izchisliTsena() {
    const broi = parseInt(document.getElementById('sel-paket').value);
    const otstapka = parseInt(document.getElementById('sel-otstapka').value);
    const srok = document.getElementById('sel-srok').value;
    const paket = nastroiki.paketi.find(p => p.broi === broi);
    const krainaTsena = (paket.tsena * (1 - otstapka / 100)).toFixed(2);
    const krainaData = izchisliKrainaData(srok);
    document.getElementById('final-price').innerText = krainaTsena + "‚Ç¨";
    document.getElementById('price-details').innerText = `–û—Ç—Å—Ç—ä–ø–∫–∞: ${otstapka}% | –°—Ä–æ–∫: ${srok == 0 ? '–ë–µ–∑ —Å—Ä–æ–∫' : srok + ' –¥–Ω–∏'} | –í–∞–ª–∏–¥–µ–Ω –¥–æ: ${krainaData} –≥.`;
}

function otvoriDobavyane() {
    tekushtKlientId = null;
    rezhimRedaktirane = false;
    snimkaBase64 = "";
    document.getElementById('add-view-title').innerText = "–ù–û–í –ö–õ–ò–ï–ù–¢";
    document.getElementById('subscription-fields').classList.remove('hidden');
    document.getElementById('img-preview').style.display = 'none';
    document.getElementById('inp-name').value = "";
    document.getElementById('inp-phone').value = "";
    document.getElementById('inp-email').value = "";
    izchisliTsena();
    pokajiSektsiya('view-add');
}

function otvoriRedaktirane(id) {
    const k = klienti.find(x => x.id === id);
    tekushtKlientId = id;
    rezhimRedaktirane = true;
    document.getElementById('add-view-title').innerText = "–†–ï–î–ê–ö–¶–ò–Ø –ù–ê –ü–†–û–§–ò–õ";
    document.getElementById('subscription-fields').classList.add('hidden');
    document.getElementById('inp-name').value = k.name;
    document.getElementById('inp-phone').value = k.phone || "";
    document.getElementById('inp-email').value = k.email || "";
    if (k.photo) {
        document.getElementById('img-preview').src = k.photo;
        document.getElementById('img-preview').style.display = 'block';
        snimkaBase64 = k.photo;
    }
    pokajiSektsiya('view-add');
}

function zapaziKlient() {
    const name = document.getElementById('inp-name').value.trim();
    if (!name) { alert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ!"); return; }
    playBeep();

    if (rezhimRedaktirane && tekushtKlientId) {
        let k = klienti.find(x => x.id === tekushtKlientId);
        if (k) {
            k.name = name;
            k.phone = document.getElementById('inp-phone').value;
            k.email = document.getElementById('inp-email').value;
            k.photo = snimkaBase64;
        }
    } else {
        const broi = parseInt(document.getElementById('sel-paket').value);
        const srok = parseInt(document.getElementById('sel-srok').value);
        const otstapka = parseInt(document.getElementById('sel-otstapka').value);
        const kData = izchisliKrainaData(srok);
        const kTsena = document.getElementById('final-price').innerText;

        const novAbonament = {
            broi: broi, napraveni: 0, srok: srok, otstapka: otstapka,
            startData: new Date().toLocaleDateString('bg-BG'),
            krainaData: kData, tsena: kTsena
        };

        if (tekushtKlientId) {
            let k = klienti.find(x => x.id === tekushtKlientId);
            if (k) {
                k.abonament = novAbonament;
                k.history.unshift({ data: new Date().toLocaleDateString('bg-BG'), tip: "–ü–æ–¥–Ω–æ–≤–µ–Ω –∞–±–æ–Ω–∞–º–µ–Ω—Ç" });
            }
        } else {
            const novKlient = {
                id: Date.now(),
                name: name,
                photo: snimkaBase64,
                phone: document.getElementById('inp-phone').value,
                email: document.getElementById('inp-email').value,
                abonament: novAbonament,
                history: [{ data: new Date().toLocaleDateString('bg-BG'), tip: "–ù–æ–≤ –∞–±–æ–Ω–∞–º–µ–Ω—Ç" }]
            };
            klienti.push(novKlient);
        }
    }

    localStorage.setItem('gym_klienti', JSON.stringify(klienti));
    renderList();
    if (tekushtKlientId) otvoriProfil(tekushtKlientId); else pokajiSektsiya('view-main');
}

function otvoriProfil(id) {
    tekushtKlientId = id;
    hronologiyaRazgurnata = false;
    const k = klienti.find(x => x.id === id);
    const a = k.abonament;
    const ostavashti = a.broi - a.napraveni;
    const headerCont = document.getElementById('profile-header-content');
    headerCont.innerHTML = `
        <div style="background:var(--tile); padding:15px; display:flex; gap:15px; align-items:flex-start">
            <img src="${k.photo || 'https://via.placeholder.com/80'}" style="width:90px; height:90px; object-fit:cover; border:1px solid #ccc">
            <div style="flex:1">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h2 style="margin:0; text-transform:uppercase; font-size:1.1rem">${k.name}</h2>
                    <span class="icon-btn" onclick="otvoriRedaktirane(${k.id})" style="color:var(--accent); width:20px; height:20px">
                        <svg viewBox="0 0 24 24" style="fill:var(--accent)"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    </span>
                </div>
                <div class="info-block">
                    <div class="info-row"><b>–ü–∞–∫–µ—Ç:</b> ${a.broi} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
                    <div class="info-row"><b>–°—Ç–∞—Ç—É—Å:</b> <span class="status-badge ${ostavashti > 0 ? 'active-status' : 'inactive-status'}">${ostavashti > 0 ? '–ê–ö–¢–ò–í–ï–ù' : '–ù–ï–ê–ö–¢–ò–í–ï–ù'}</span></div>
                    <div class="info-row"><b>–¶–µ–Ω–∞:</b> ${a.tsena} (–æ—Ç—Å—Ç—ä–ø–∫–∞ ${a.otstapka}%)</div>
                    <div class="info-row"><b>–í–∞–ª–∏–¥–Ω–æ—Å—Ç:</b> ${a.srok == 0 ? '–ë–µ–∑ —Å—Ä–æ–∫' : a.srok + ' –¥–Ω–∏'}</div>
                    <div class="info-row"><b>–ö—Ä–∞–π –Ω–∞ –ø–∞–∫–µ—Ç–∞:</b> ${a.krainaData} –≥.</div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('counter-tiles-container').innerHTML = `
        <div class="metro-grid">
            <div class="metro-counter-tile">
                <div class="counter-label" style="color:var(--red)">–ù–ê–ü–†–ê–í–ï–ù–ò</div>
                <div class="counter-value">${a.napraveni}</div>
            </div>
            <div class="metro-counter-tile">
                <div class="counter-label" style="color:var(--green)">–û–°–¢–ê–í–ê–©–ò</div>
                <div class="counter-value">${ostavashti}</div>
            </div>
        </div>
    `;
    const btnMark = document.getElementById('btn-markiraj');
    if (ostavashti <= 0) {
        btnMark.className = "btn btn-blue";
        btnMark.innerText = "–ü–û–î–ù–û–í–ò –ê–ë–û–ù–ê–ú–ï–ù–¢";
        btnMark.onclick = () => {
            tekushtKlientId = k.id;
            rezhimRedaktirane = false;
            document.getElementById('add-view-title').innerText = "–ü–û–î–ù–û–í–Ø–í–ê–ù–ï";
            document.getElementById('subscription-fields').classList.remove('hidden');
            document.getElementById('inp-name').value = k.name;
            izchisliTsena();
            pokajiSektsiya('view-add');
        };
    } else {
        btnMark.className = "btn btn-green";
        btnMark.innerText = "–ú–ê–†–ö–ò–†–ê–ô –¢–†–ï–ù–ò–†–û–í–ö–ê";
        btnMark.onclick = markirajTrenirovka;
    }
    renderHronologiya(k.history);
    pokajiSektsiya('view-profile');
}

async function obrabotiSnimka(input) {
    const file = input.files[0];
    if (file) {
        snimkaBase64 = await toBase64(file);
        const preview = document.getElementById('img-preview');
        preview.src = snimkaBase64; preview.style.display = 'block';
    }
}
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
});

function markirajTrenirovka() {
    playBeep(); 
    const k = klienti.find(x => x.id === tekushtKlientId);
    if (!k || k.abonament.napraveni >= k.abonament.broi) return;
    const tip = document.getElementById('sel-trenirovka').value;
    k.abonament.napraveni++;
    k.history.unshift({ data: new Date().toLocaleDateString('bg-BG'), tip: tip });
    localStorage.setItem('gym_klienti', JSON.stringify(klienti));
    otvoriProfil(tekushtKlientId);
}

function renderHronologiya(history) {
    const list = document.getElementById('hronologiya-list');
    const btn = document.getElementById('btn-toggle-hronologiya');
    const items = hronologiyaRazgurnata ? history : history.slice(0, 3);
    list.innerHTML = items.map(h => `<div class="istoriya-item">üìÖ ${h.data} –≥. - ${h.tip}</div>`).join('');
    btn.innerText = hronologiyaRazgurnata ? "–°–í–ò–ô –°–ü–ò–°–™–ö–ê" : "–í–ò–ñ –í–°–ò–ß–ö–ò";
}

function razshiriHronologiya() {
    hronologiyaRazgurnata = !hronologiyaRazgurnata;
    const k = klienti.find(x => x.id === tekushtKlientId);
    if(k) renderHronologiya(k.history);
}

function generirajOtchet() {
    const k = klienti.find(x => x.id === tekushtKlientId);
    if(!k) return;
    const a = k.abonament;
    const ostavashti = a.broi - a.napraveni;
    const lastActivity = k.history[0] || { data: "---", tip: "–ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç" };
    const text = `üìä –û–¢–ß–ï–¢ –ó–ê –ö–õ–ò–ï–ù–¢\nüë§ ${k.name}\n\nüì¶ –ü–∞–∫–µ—Ç: ${a.broi} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–∞–Ω: ${a.startData} –≥.\n‚è≥ –í–∞–ª–∏–¥–µ–Ω –¥–æ: ${a.krainaData} –≥.\n\n‚úîÔ∏è –ù–∞–ø—Ä–∞–≤–µ–Ω–∏: ${a.napraveni}\nüîú –û—Å—Ç–∞–≤–∞—â–∏: ${ostavashti}\n\nüìú –ü–û–°–õ–ï–î–ù–ò –ê–ö–¢–ò–í–ù–û–°–¢–ò:\nüóìÔ∏è ${lastActivity.data} –≥. ${lastActivity.tip}`;
    window.location.href = `viber://forward?text=${encodeURIComponent(text)}`;
}

function iztriiKlientPotvarjdenie() {
    if (confirm("–í–ù–ò–ú–ê–ù–ò–ï: –°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ –∫–ª–∏–µ–Ω—Ç –∏ —Ü–µ–ª–∏—è –º—É –∞–∫–∞—É–Ω—Ç?")) {
        klienti = klienti.filter(k => k.id !== tekushtKlientId);
        localStorage.setItem('gym_klienti', JSON.stringify(klienti));
        renderList();
        pokajiSektsiya('view-main');
    }
}

function pokajiSektsiya(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
    document.getElementById(id).classList.add('active-view');
    window.scrollTo(0,0);
}

function switchTab(id, btn) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.remove('hidden'); btn.classList.add('active');
}

function zapaziNastroiki() {
    nastroiki.header = document.getElementById('set-header-text').value;
    nastroiki.theme = document.getElementById('set-theme').value;
    nastroiki.fontSize = document.getElementById('set-font').value;
    nastroiki.accent = document.getElementById('set-accent').value;
    nastroiki.trenirovki = document.getElementById('set-trenirovki').value;
    nastroiki.gasUrl = document.getElementById('set-gas-url').value;
    try { nastroiki.paketi = JSON.parse(document.getElementById('set-paketi').value); } catch(e) {}
    localStorage.setItem('gym_settings', JSON.stringify(nastroiki));
    init();
}

async function sinhroniziraj() {
    const url = nastroiki.gasUrl;
    if (!url) { alert("–ú–æ–ª—è, –ø–æ—Å—Ç–∞–≤–µ—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ!"); return; }
    
    // –û–ª–µ–∫–æ—Ç—è–≤–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ (–º–∞—Ö–∞–º–µ —Å–Ω–∏–º–∫–∏—Ç–µ)
    const dataToSync = klienti.map(k => {
        const { photo, ...rest } = k;
        return rest;
    });

    // –°—ä–∑–¥–∞–≤–∞–º–µ —Å–∫—Ä–∏—Ç–∞ —Ñ–æ—Ä–º–∞, –∑–∞ –¥–∞ –∑–∞–æ–±–∏–∫–æ–ª–∏–º CORS –∑–∞—â–∏—Ç–∏—Ç–µ
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    form.target = 'hidden_iframe'; // –ò–∑–ø—Ä–∞—â–∞ –±–µ–∑ –¥–∞ –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'data';
    input.value = JSON.stringify(dataToSync);
    form.appendChild(input);

    // –°–∫—Ä–∏—Ç iframe –∑–∞ "—Ç–∏—Ö–æ" –∏–∑–ø—Ä–∞—â–∞–Ω–µ
    let iframe = document.getElementById('hidden_iframe');
    if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'hidden_iframe';
        iframe.name = 'hidden_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
    }

    document.body.appendChild(form);
    form.submit();
    
    alert("–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ –ø–æ –∑–∞—â–∏—Ç–µ–Ω –∫–∞–Ω–∞–ª! –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å–ª–µ–¥ –º–∞–ª–∫–æ.");
    document.body.removeChild(form);
}
function eksportDanni() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(klienti));
    const dl = document.createElement('a'); dl.setAttribute("href", dataStr);
    dl.setAttribute("download", "gym_backup.json"); dl.click();
}

function importDanni() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0]; const reader = new FileReader();
        reader.readAsText(file, 'UTF-8');
        reader.onload = re => {
            try {
                klienti = JSON.parse(re.target.result);
                localStorage.setItem('gym_klienti', JSON.stringify(klienti));
                renderList(); alert("–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏!");
            } catch(ex) { alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞!"); }
        }
    }
    input.click();
}

init();

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('PWA Ready'))
      .catch(err => console.log('SW Error', err));
  });
}
</script>
</body>
</html>



