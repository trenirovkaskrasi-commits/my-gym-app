<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>АБОНАМЕНТИ - GYM</title>
    <style>
        :root {
            --accent: #0078D7;
            --bg: #ffffff;
            --text: #000000;
            --tile: #eff2f5;
            --green: #267a26;
            --blue: #005a9e;
            --red: #a80000;
            --purple: #7232ad;
            --dark-red: #8b0000;
            --font-main: 'Segoe UI', sans-serif;
        }
        [data-theme="dark"] { --bg: #000000; --text: #ffffff; --tile: #1a1a1a; }
        * { box-sizing: border-box; border-radius: 0 !important; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font-main); overflow-x: hidden; }
        header { background: var(--accent); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .container { padding: 10px; max-width: 600px; margin: 0 auto; }
        .klient-tile { background: var(--tile); display: grid; grid-template-columns: 70px 1fr 50px; align-items: center; padding: 10px; margin-bottom: 5px; cursor: pointer; border: 1px solid #ddd; }
        .klient-photo { width: 60px; height: 60px; object-fit: cover; background: #ccc; }
        .status-badge { font-weight: 900; font-size: 0.7rem; padding: 2px 6px; text-transform: uppercase; margin-top: 5px; display: inline-block; }
        .active-status { background: var(--green); color: white; }
        .inactive-status { background: var(--red); color: white; }
        .rem-count { font-size: 1.4rem; font-weight: 900; text-align: right; color: var(--accent); }
        input, select { width: 100%; padding: 12px; background: var(--tile); border: 2px solid #ccc; color: var(--text); font-weight: bold; margin-bottom: 10px; }
        .btn { border: none; padding: 16px; color: white; font-weight: 900; text-transform: uppercase; cursor: pointer; display: block; width: 100%; margin-bottom: 8px; text-align: center; }
        .btn-green { background: var(--green); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-purple { background: var(--purple); }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 99; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .view { display: none; }
        .active-view { display: block; }
    </style>
</head>
<body data-theme="light">

<header>
    <h1 style="margin:0; font-size:1.1rem;">GYM MANAGER</h1>
    <div onclick="pokajiSektsiya('view-settings')" style="cursor:pointer; font-size:1.4rem;">⚙️</div>
</header>

<div class="container">
    <div id="view-main" class="view active-view">
        <input type="text" id="search-input" placeholder="Търси име..." oninput="renderList()">
        <div id="klient-list-container"></div>
        <div class="fab" onclick="otvoriDobavyane()">+</div>
    </div>

    <div id="view-add" class="view">
        <h2 id="add-title">НОВ КЛИЕНТ</h2>
        <input type="file" accept="image/*" onchange="obrabotiSnimka(this)">
        <img id="img-preview" style="width:100%; height:150px; object-fit:cover; display:none; margin-bottom:10px;">
        <input type="text" id="inp-name" placeholder="Име и фамилия">
        <div id="new-sub-fields">
            <label style="font-size: 0.8rem;">Пакет тренировки:</label>
            <select id="sel-paket">
                <option value="8">8 тренировки</option>
                <option value="10">10 тренировки</option>
                <option value="12">12 тренировки</option>
                <option value="20">20 тренировки</option>
            </select>
        </div>
        <button class="btn btn-blue" onclick="zapaziKlient()">ЗАПАЗИ</button>
        <button class="btn btn-red" onclick="pokajiSektsiya('view-main')">ОТКАЗ</button>
    </div>

    <div id="view-profile" class="view">
        <div id="profile-content" style="text-align:center; padding:20px; background:var(--tile); margin-bottom:15px;"></div>
        <button class="btn btn-green" onclick="markirajTrenirovka()">МАРКИРАЙ ТРЕНИРОВКА</button>
        <button class="btn btn-purple" onclick="window.location.href='viber://forward?text='+encodeURIComponent(otchetText)">ОТЧЕТ ВАЙБЪР</button>
        <button class="btn btn-red" onclick="iztriiKlient()">ИЗТРИЙ КЛИЕНТ</button>
        <button class="btn btn-blue" onclick="pokajiSektsiya('view-main')">ОБРАТНО</button>
    </div>

    <div id="view-settings" class="view">
        <h2>НАСТРОЙКИ</h2>
        <label>Google Script URL:</label>
        <input type="text" id="set-gas-url" placeholder="Поставете линка тук...">
        <button class="btn btn-blue" onclick="zapaziURL()">ЗАПАЗИ URL</button>
        <hr>
        <button class="btn btn-green" onclick="sinhroniziraj()">СИНХРОНИЗИРАЙ СЕГА</button>
        <button class="btn btn-purple" onclick="eksportDanni()">ЕКСПОРТ (БЕКЪП)</button>
        <button class="btn btn-blue" onclick="importDanni()">ИМПОРТ</button>
        <button class="btn btn-red" onclick="pokajiSektsiya('view-main')">ЗАТВОРИ</button>
    </div>
</div>

<script>
let klienti = JSON.parse(localStorage.getItem('gym_klienti')) || [];
let gUrl = localStorage.getItem('gym_gurl') || "";
let tekushtKlientId = null;
let snimkaBase64 = "";
let otchetText = "";

function renderList() {
    const query = document.getElementById('search-input').value.toLowerCase();
    const container = document.getElementById('klient-list-container');
    container.innerHTML = "";
    klienti.filter(k => k.name.toLowerCase().includes(query)).forEach(k => {
        const ost = k.abonament.broi - k.abonament.napraveni;
        const div = document.createElement('div');
        div.className = 'klient-tile';
        div.onclick = () => otvoriProfil(k.id);
        div.innerHTML = `
            <img src="${k.photo || ''}" class="klient-photo">
            <div style="padding-left:10px">
                <div style="font-weight:bold">${k.name}</div>
                <span class="status-badge ${ost > 0 ? 'active-status' : 'inactive-status'}">${ost > 0 ? 'Активен' : 'Изтекъл'}</span>
            </div>
            <div class="rem-count">${ost}</div>
        `;
        container.appendChild(div);
    });
}

function otvoriDobavyane() {
    tekushtKlientId = null; // ВАЖНО: Нулираме, за да знае, че е нов клиент
    snimkaBase64 = "";
    document.getElementById('inp-name').value = "";
    document.getElementById('img-preview').style.display = 'none';
    document.getElementById('add-title').innerText = "НОВ КЛИЕНТ";
    document.getElementById('new-sub-fields').style.display = "block";
    pokajiSektsiya('view-add');
}

function zapaziKlient() {
    const name = document.getElementById('inp-name').value.trim();
    if (!name) return alert("Въведете име!");

    const broi = parseInt(document.getElementById('sel-paket').value);
    const nov = {
        id: Date.now(),
        name: name,
        photo: snimkaBase64,
        abonament: { broi: broi, napraveni: 0, krainaData: "Без срок" },
        history: []
    };

    klienti.push(nov);
    localStorage.setItem('gym_klienti', JSON.stringify(klienti));
    renderList();
    pokajiSektsiya('view-main');
}

function otvoriProfil(id) {
    tekushtKlientId = id;
    const k = klienti.find(x => x.id === id);
    const ost = k.abonament.broi - k.abonament.napraveni;
    otchetText = `Клиент: ${k.name}\nОстават: ${ost} тренировки`;
    
    document.getElementById('profile-content').innerHTML = `
        <img src="${k.photo || ''}" style="width:120px; height:120px; object-fit:cover; border-radius:50%;">
        <h2 style="margin:10px 0;">${k.name}</h2>
        <div style="font-size:3rem; font-weight:bold; color:var(--accent);">${ost}</div>
        <div style="font-size:0.8rem; color:#666;">ОСТАВАЩИ ТРЕНИРОВКИ</div>
    `;
    pokajiSektsiya('view-profile');
}

function markirajTrenirovka() {
    const k = klienti.find(x => x.id === tekushtKlientId);
    if (k.abonament.napraveni < k.abonament.broi) {
        k.abonament.napraveni++;
        localStorage.setItem('gym_klienti', JSON.stringify(klienti));
        otvoriProfil(tekushtKlientId);
        renderList();
    } else {
        alert("Няма повече тренировки!");
    }
}

function obrabotiSnimka(input) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = e => {
        snimkaBase64 = e.target.result;
        document.getElementById('img-preview').src = snimkaBase64;
        document.getElementById('img-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function sinhroniziraj() {
    if (!gUrl) return alert("Въведете URL в настройките!");
    const cleanData = klienti.map(k => { const {photo, ...rest} = k; return rest; });
    const finalUrl = gUrl + "?data=" + encodeURIComponent(JSON.stringify(cleanData));
    const img = new Image();
    img.src = finalUrl;
    alert("Данните са изпратени към таблицата!");
}

function zapaziURL() {
    gUrl = document.getElementById('set-gas-url').value;
    localStorage.setItem('gym_gurl', gUrl);
    alert("URL е запазен!");
}

function iztriiKlient() {
    if (confirm("Изтриване на клиента?")) {
        klienti = klienti.filter(k => k.id !== tekushtKlientId);
        localStorage.setItem('gym_klienti', JSON.stringify(klienti));
        renderList();
        pokajiSektsiya('view-main');
    }
}

function eksportDanni() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(klienti));
    const dl = document.createElement('a'); dl.setAttribute("href", dataStr);
    dl.setAttribute("download", "gym_backup.json"); dl.click();
}

function importDanni() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const file = e.target.files[0]; const reader = new FileReader();
        reader.readAsText(file, 'UTF-8');
        reader.onload = re => {
            klienti = JSON.parse(re.target.result);
            localStorage.setItem('gym_klienti', JSON.stringify(klienti));
            renderList(); alert("Данните са импортирани!");
        };
    };
    input.click();
}

function pokajiSektsiya(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
    document.getElementById(id).classList.add('active-view');
}

document.getElementById('set-gas-url').value = gUrl;
renderList();
</script>
</body>
</html>
